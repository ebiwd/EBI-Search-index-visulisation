var svg=d3.select("svg"),width=+svg.attr("width"),height=+svg.attr("height"),tau=2*Math.PI,color=d3.scaleOrdinal(d3.schemeCategory20);d3.json("data.json",function(b,c){if(b)throw b;c=customStratify(c.domains);var k=d3.transition().duration(750).ease(d3.easeLinear),l=d3.tip().attr("class","d3-tip").offset([-8,0]).direction(function(q){return 580>q.x?"e":900<q.x?"w":"n"}).html(function(q){var r=Math.floor(q.size/1e4)/100;return 0.02<r?r+"M<br/>"+q.name:Math.floor(q.size/10)/100+"K<br/>"+q.name});svg.call(l);var m=svg.append("g").attr("class","links").selectAll("line").data(c.links).enter().append("line").attr("opacity",0).attr("stroke-width",function(q){return Math.sqrt(q.value)}),n=svg.append("g").attr("class","nodes").selectAll(".nodes").data(c.nodes).enter().append("g").attr("transform",function(q){return"translate("+q.x+","+q.y+")"});n.append("circle").attr("r",function(q){return Math.sqrt(Math.sqrt(q.size/100))+0}).attr("fill",function(){return"rgba(255,255,255,0.0)"}).attr("opacity",0).attr("stroke",function(q){return color(q.group)}).on("mouseover",l.show).on("mouseout",l.hide),window.collide=d3.bboxCollide(function(q){return[[q.offsetCornerX-5,q.offsetCornerY-10],[q.offsetCornerX+q.width+5,q.offsetCornerY+q.height+5]]}).strength(0.5).iterations(1);var p=c.nodes.filter(function(q){return"1"==q.level});window.makeAnnotations=d3.annotation().type(d3.annotationLabel).annotations(p.map(function(q){return{data:{x:q.x,y:q.y,group:q.group},note:{label:q.name},subject:{radius:50,radiusPadding:10},className:"group-"+q.group}})).accessors({x:function x(q){return q.x},y:function y(q){return q.y}}),svg.append("g").attr("opacity",0).attr("class","annotation-group").call(makeAnnotations);var o=d3.forceSimulation(c.nodes).velocityDecay(0.1).alphaDecay(.1).alpha(1).force("x",d3.forceX().strength(0.038)).force("y",d3.forceY().strength(0.238)).force("link",d3.forceLink().id(function(q){return q.id}).distance(200).strength(1)).force("collide",d3.forceCollide().radius(function(q){return Math.sqrt(Math.sqrt(q.size/100))+1}).strength(1).iterations(10)).force("center",d3.forceCenter(width/1.7,height/2.3)).on("tick",function(){n.attr("transform",function(q){return"translate("+q.x+","+q.y+")"}),m.attr("x1",function(q){return q.source.x}).attr("y1",function(q){return q.source.y}).attr("x2",function(q){return q.target.x}).attr("y2",function(q){return q.target.y}),makeAnnotations.annotations().forEach(function(q,r){q.position=p[r]})}).on("end",function(){var q=makeAnnotations.collection().noteNodes;window.labelForce=d3.forceSimulation(q).force("x",d3.forceX(function(r){return r.positionX}).strength(function(r){return Math.max(0.25,Math.min(3,Math.abs(r.x-r.positionX)/20))})).force("y",d3.forceY(function(r){return r.positionY}).strength(function(r){return Math.max(0.25,Math.min(3,Math.abs(r.x-r.positionX)/20))})).force("collision",window.collide).alpha(0.5).on("tick",function(){makeAnnotations.annotations().forEach(function(s,u){var v=q[u];s.dx=v.x-v.positionX,s.dy=v.y-v.positionY})})});o.force("link").links(c.links).distance(10),d3.selectAll("circle").transition(k).delay(1e3).attr("opacity",1),d3.selectAll(".legendSize").transition(k).delay(1900).attr("opacity",.5),d3.selectAll(".annotation-group").transition(k).delay(function(){return 2e3*Math.random()+2e3}).attr("opacity",1)});var linearSize=d3.scalePow().exponent(.19).domain([0,80000000]).range([1,25]);svg.append("g").attr("class","legendSize").attr("stroke","#fff").attr("fill","#000").attr("transform","translate("+(width-250)+", "+(height-150)+")");var legendSize=d3.legendSize().scale(linearSize).shape("circle").shapePadding(2).labelFormat(".0s").cells(5).title("Millions of entries in each domain").labelOffset(15).orient("horizontal");svg.select(".legendSize").attr("opacity","0").call(legendSize),svg.select(".legendSize text.legendTitle").attr("transform",function(){return"translate(0,-10)"}).call(legendSize);function customStratify(b){var f,c=b.length,e={nodes:[],links:[]};for(f=0;f<c;f+=1){var g="to generate",h=0,j=0;0===f?(g="Genomes & metagenomes",h=50,j=20):1===f?(g="Nucelotide sequences",h=50,j=20):2===f?(g="Protein sequences",h=50,j=20):3===f?(g="Macromolecular structures",h=500,j=20):4===f?(g="Macromolecular structures",h=50,j=20):5===f?(g="Gene expression",h=50,j=20):6===f?(g="Molecular interactions",h=50,j=20):7===f?(g="Reactions, pathways & diseases",h=10,j=10):8===f?(g="Gene expression",h=50,j=20):9===f?(g="Protein expression data",h=50,j=20):10===f?(g="Enzymes",h=50,j=20):11===f?(g="Literature",h=50,j=20):12===f?(g="Samples & ontologies",h=50,j=20):13===f?(g="EBI web",h=500,j=30):void 0;for(e.nodes.push({id:"parent-record-"+f,name:g,group:f,size:1,level:1,x:h,y:j}),i2=0;i2<b[f].subdomains.domain.length;i2+=1){var k=b[f].subdomains.domain[i2];if(k.subdomains==void 0){k["-description"]==void 0&&(k["-description"]=g);var l=k["-description"];e.nodes.push({id:l+"-"+f+"-"+i2,name:l,group:f,size:k.indexInfos.indexInfo[0]["#text"],filesize:k.indexInfos.indexInfo[2]["#text"],level:2,x:h,y:j}),e.links.push({source:l+"-"+f+"-"+i2,target:"parent-record-"+f,value:1})}else for(e.nodes.push({id:"parent-sub-record-"+f+"-"+i2,name:k["-description"],group:f,size:100,level:2,x:h,y:j}),e.links.push({source:"parent-sub-record-"+f+"-"+i2,target:"parent-record-"+f,value:1}),i3=0;i3<k.subdomains.domain.length;i3+=1){var m=k.subdomains.domain[i3];if(void 0==m.subdomains){void 0==m["-description"]&&(m["-description"]=g);var n=m["-description"];e.nodes.push({id:n+"-"+f+"-"+i2+"-"+i3,name:n,group:f,size:m.indexInfos.indexInfo[0]["#text"],filesize:m.indexInfos.indexInfo[2]["#text"],level:3,x:h,y:j}),e.links.push({source:n+"-"+f+"-"+i2+"-"+i3,target:"parent-sub-record-"+f+"-"+i2,value:1})}else for(e.nodes.push({id:"parent-sub-record-"+f+"-"+i2+"-"+i3,name:m["-description"],group:f,size:100,level:4,x:h,y:j}),e.links.push({source:"parent-sub-record-"+f+"-"+i2+"-"+i3,target:"parent-record-"+f,value:1}),i4=0;i4<m.subdomains.domain.length;i4+=1){var o=m.subdomains.domain[i4];if(void 0!=o)if(void 0==o.subdomains){if(void 0!=o["-description"])var p=o["-description"];else var p=" ";e.nodes.push({id:p+"-"+f+"-"+i2+"-"+i3+"-"+i4,name:p,group:f,size:o.indexInfos.indexInfo[0]["#text"],level:4,x:h,y:j}),e.links.push({source:p+"-"+f+"-"+i2+"-"+i3+"-"+i4,target:"parent-sub-record-"+f+"-"+i2+"-"+i3,value:1})}else console.log(o)}}}}return e}
